{% extends 'base.html' %}
{% load static %}

{% block title %}Nouvelle réservation - ArenaGym Padel{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Nouvelle réservation</h3>
            </div>
            <div class="card-body">
                <form method="post" id="reservation-form">
                    {% csrf_token %}
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="id_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="id_date" name="date" required>
                        </div>
                        <div class="col-md-3">
                            <label for="id_start_time" class="form-label">Heure de début</label>
                            <select class="form-select" id="id_start_time" name="start_time" required>
                                <option value="" selected disabled>Sélectionnez</option>
                                {% for time in available_times %}
                                <option value="{{ time }}">{{ time|time:"H:i" }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="id_end_time" class="form-label">Heure de fin</label>
                            <select class="form-select" id="id_end_time" name="end_time" required>
                                <option value="" selected disabled>Sélectionnez</option>
                                {% for time in available_times %}
                                <option value="{{ time }}">{{ time|time:"H:i" }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_court" class="form-label">Terrain</label>
                        <select class="form-select" id="id_court" name="court" required>
                            <option value="" selected disabled>Sélectionnez un terrain</option>
                            {% for court in courts %}
                            <option value="{{ court.id }}">Terrain {{ court.number }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    {% if user.is_coach %}
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="id_is_lesson" name="is_lesson">
                        <label class="form-check-label" for="id_is_lesson">C'est un cours avec un coach</label>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="id_notes" class="form-label">Notes supplémentaires</label>
                        <textarea class="form-control" id="id_notes" name="notes" rows="3"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'reservations:list' %}" class="btn btn-secondary me-md-2">Annuler</a>
                        <button type="submit" class="btn btn-primary">Réserver</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update end time options based on start time selection
    document.getElementById('id_start_time').addEventListener('change', function() {
        const startTime = this.value;
        const endTimeSelect = document.getElementById('id_end_time');
        
        // Clear existing options
        endTimeSelect.innerHTML = '<option value="" selected disabled>Sélectionnez</option>';
        
        // Add new options that are after the selected start time
        const startIndex = Array.from(document.getElementById('id_start_time').options).findIndex(
            option => option.value === startTime
        );
        
        const options = document.getElementById('id_start_time').options;
        for (let i = startIndex + 1; i < options.length; i++) {
            const option = document.createElement('option');
            option.value = options[i].value;
            option.textContent = options[i].textContent;
            endTimeSelect.appendChild(option);
        }
    });
    
    // Check court availability when date or times change
    const checkAvailability = debounce(function() {
        const date = document.getElementById('id_date').value;
        const startTime = document.getElementById('id_start_time').value;
        const endTime = document.getElementById('id_end_time').value;
        
        if (date && startTime && endTime) {
            fetch(`/api/courts/availability/?date=${date}&start_time=${startTime}&end_time=${endTime}`)
                .then(response => response.json())
                .then(data => {
                    const courtSelect = document.getElementById('id_court');
                    Array.from(courtSelect.options).forEach(option => {
                        if (option.value) {
                            const courtId = parseInt(option.value);
                            option.disabled = !data.available_courts.includes(courtId);
                            if (option.disabled) {
                                option.textContent = `Terrain ${option.textContent.split(' ')[1]} (Indisponible)`;
                            } else {
                                option.textContent = `Terrain ${option.textContent.split(' ')[1]}`;
                            }
                        }
                    });
                });
        }
    }, 300);
    
    document.getElementById('id_date').addEventListener('change', checkAvailability);
    document.getElementById('id_start_time').addEventListener('change', checkAvailability);
    document.getElementById('id_end_time').addEventListener('change', checkAvailability);
    
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                func.apply(context, args);
            }, wait);
        };
    }
});
</script>
{% endblock %}