{% load static %}
{% load form_filters %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book a Court</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'home' %}">Arena GYM</a>
        <div class="d-flex">
            <form method="POST" action="{% url 'logout' %}">
                {% csrf_token %}
                <button class="btn btn-outline-light" type="submit">Logout</button>
            </form>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h2 class="text-center mb-4">Book a Court</h2>

    <div class="card p-4 mx-auto shadow" style="max-width: 600px;">
        <form method="POST">
            {% csrf_token %}
            {% for field in form %}
                <div class="mb-3" id="field-{{ field.name }}"  {% if field.name == 'booking_duration' or field.name == 'num_people' %} style="display: none;" {% endif %}>
                    <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                    {{ field|add_class:"form-control" }}
                    {% for error in field.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>
            {% endfor %}

            <!-- Only show these fields if a coach is selected -->
            <div id="coach-options" style="display: none;">
                <div class="mb-3">
                    <label class="form-label" for="{{ form.booking_duration.id_for_label }}">Booking Duration</label>
                    {{ form.booking_duration }}
                </div>
                <div class="mb-3">
                    <label class="form-label" for="{{ form.num_people.id_for_label }}">Number of People</label>
                    {{ form.num_people }}
                </div>
            </div>

            <!-- Display Total Price and Confirm Reservation Button on the Same Line -->
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <label class="form-label mb-0">Total Price</label>
                <div id="total-price" class="form-control-plaintext mb-0">
                    {{ total_price }} DT
                </div>
                <button class="btn btn-primary" type="submit">Confirm Reservation</button>
            </div>

        </form>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Set initial total price
        var initialPrice = "{{ total_price|default:'120' }}";
        $('#total-price').text(initialPrice + " DT");

        // Check if a coach is pre-selected
        var coachSelected = $('#id_coach').val() !== "";
        $('#coach-options').toggle(coachSelected);

        // Handle coach selection
        $('#id_coach').change(function () {
            var coachSelected = $(this).val() !== "";
            $('#coach-options').toggle(coachSelected);

            // Get coach's rate if a coach is selected
            if (coachSelected) {
                var coachrate = parseFloat($('#id_coach option:selected').data('rate'));
                var duration = $('input[name="booking_duration"]:checked').val();
                var numPeople = $('select[name="num_people"]').val();
                
                // Adjust total price based on booking duration and number of people
                var totalPrice = coachrate;
                if (duration === '1h') {
                    totalPrice /= 2; // Example: Half price for 1 hour
                }

                if (numPeople == 2) {
                    totalPrice *= 2; // Double the price if there are 2 people
                }

                $('#total-price').text(totalPrice + " DT");
            } else {
                // Reset to default price if no coach is selected
                $('#total-price').text('120 DT');
            }
        });

        // Handle booking duration and number of people changes
        $('input[name="booking_duration"], select[name="num_people"]').change(function () {
            var coachSelected = $('#id_coach').val() !== "";
            if (coachSelected) {
                var coachrate = parseFloat($('#id_coach option:selected').data('rate'));
                var duration = $('input[name="booking_duration"]:checked').val();
                var numPeople = $('select[name="num_people"]').val();
                
                var totalPrice = coachrate;
                if (duration === '1h') {
                    totalPrice /= 2;
                }

                if (numPeople == 2) {
                    totalPrice *= 2;
                }

                $('#total-price').text(totalPrice + " DT");
            }
        });
    });
</script>

</body>
</html>
